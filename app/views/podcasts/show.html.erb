<div class="max-w-4xl mx-auto px-4 py-8 font-sans">
  <!-- Episode Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-semibold text-gray-900 mb-2"><%= @episode.name %></h1>
    <p class="text-gray-600"><%= @episode.show.publisher %></p>
  </div>

  <!-- Player Section -->
  <div class="mb-8 bg-white rounded-lg shadow-sm">
    <iframe
      class="w-full rounded-lg"
      src="https://open.spotify.com/embed/episode/<%= @episode.id %>"
      height="152"
      frameborder="0"
      allowfullscreen
      allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
      loading="lazy">
    </iframe>
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-wrap gap-3 mb-8">
    <% if current_user.episodes&.exists?(spotify_id: @episode.id) %>
      <%= button_to 'Remove from Favorites',
                    unfavorite_podcast_path(id: @episode.id),
                    method: :delete,
                    class: 'px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors' %>
      
      <% user_episode = current_user.episodes.find_by(spotify_id: @episode.id) %>
      
      <% if user_episode.played %>
        <%= button_to 'Mark as Unplayed',
                    unplayed_podcast_path(id: @episode.id),
                    method: :patch,
                    class: 'px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors' %>
      <% else %>
        <%= button_to 'Mark as Played',
                    played_podcast_path(id: @episode.id),
                    method: :patch,
                    class: 'px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors' %>
      <% end %>
      
      <% if user_episode.finished %>
        <%= button_to 'Mark as Unfinished',
                    unfinished_podcast_path(id: @episode.id),
                    method: :patch,
                    class: 'px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors' %>
      <% else %>
        <%= button_to 'Mark as Finished',
                    finished_podcast_path(id: @episode.id),
                    method: :patch,
                    class: 'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors' %>
      <% end %>
    <% else %>
      <%= button_to 'Add to Favorites',
                    favorite_podcast_path(episode_id: @episode.id),
                    method: :post,
                    class: 'px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors' %>
    <% end %>
  </div>

  <!-- Episode Info -->
  <div class="bg-white rounded-lg shadow-sm p-6 mb-8 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <h2 class="text-sm font-medium text-gray-500">Language</h2>
        <p class="text-gray-900"><%= I18nData.languages[@episode.language.upcase] %></p>
      </div>
      <div>
        <h2 class="text-sm font-medium text-gray-500">Release Date</h2>
        <p class="text-gray-900"><%= @episode.release_date %></p>
      </div>
    </div>
    <div>
      <h2 class="text-sm font-medium text-gray-500 mb-2">Description</h2>
      <p class="text-gray-700 leading-relaxed"><%= @episode.description %></p>
    </div>
    <div>
      <h2 class="text-sm font-medium text-gray-500 mb-2">Episodes</h2>
      <p class="text-indigo-600 hover:text-indigo-700">
        <%= link_to @episode.show.episodes.map(&:name).join(", "), podcast_path(@episode.show.id) %>
      </p>
    </div>
  </div>

  <!-- Feedback Form -->
  <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
    <h2 class="text-xl font-semibold mb-4">Leave Feedback</h2>
    <% if user_signed_in? %>
      <p class="text-sm text-gray-600 mb-4">Commenting as: <span class="font-medium"><%= current_user.email %></span></p>
    <% end %>
    
    <%= form_with(model: @feedback, 
              url: podcast_feedbacks_path(@episode.id), 
              local: true, 
              data: { turbo: false }, 
              class: "space-y-4") do |f| %>
      <%= f.hidden_field :podcast_id, value: @episode.id %>
      <%= f.hidden_field :rating, id: 'rating-input' %>
      <div>
    <%= f.label :rating, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <div class="flex items-center space-x-1" id="star-rating">
      <% 5.times do |i| %>
        <button type="button"
                data-rating="<%= i + 1 %>"
                class="text-2xl text-gray-300 hover:text-yellow-400 focus:outline-none transition-colors star-button">
          ★
        </button>
      <% end %>
    </div>
  </div>

  <div>
    <%= f.label :comment, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= f.text_area :comment, 
                    rows: 4, 
                    required: true, 
                    class: "block w-full mt-1 rounded-md border-gray-300 shadow-sm" %>
  </div>

  <div>
    <%= f.submit "Submit Feedback", 
                 class: "w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors" %>
  </div>
<% end %>

  <!-- Existing Feedbacks -->
  <div class="bg-white rounded-lg shadow-sm p-6">
    <h2 class="text-xl font-semibold mb-4">Feedback</h2>
    <div class="space-y-6">
      <% @feedbacks.each do |feedback| %>
        <div class="border-b border-gray-200 last:border-0 pb-6 last:pb-0">
          <div class="flex items-center mb-2">
            <div class="text-yellow-400">
              <% feedback.rating.times do %>★<% end %><% (5 - feedback.rating).times do %>☆<% end %>
            </div>
          </div>
          <p class="text-gray-700 mb-3"><%= feedback.comment %></p>
          <div class="flex gap-2">
            <%= link_to 'Edit', edit_podcast_feedback_path(@episode.id, feedback), 
                 class: 'text-sm px-3 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors' %>
            <%= button_to 'Delete', 
                 podcast_feedback_path(@episode.id, feedback), 
                 method: :delete,
                 form: { data: { turbo_confirm: 'Are you sure?' } },
                 class: 'text-sm px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 transition-colors' %>
           </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const starRating = document.getElementById('star-rating');
  const ratingInput = document.getElementById('rating-input');
  const stars = starRating.getElementsByClassName('star-button');

  function setRating(rating) {
    ratingInput.value = rating;
    Array.from(stars).forEach((star, index) => {
      star.classList.toggle('text-yellow-400', index < rating);
      star.classList.toggle('text-gray-300', index >= rating);
    });
  }

  Array.from(stars).forEach(star => {
    star.addEventListener('click', function() {
      const rating = parseInt(this.dataset.rating);
      setRating(rating);
    });

    star.addEventListener('mouseover', function() {
      const rating = parseInt(this.dataset.rating);
      Array.from(stars).forEach((s, index) => {
        s.classList.toggle('text-yellow-400', index < rating);
        s.classList.toggle('text-gray-300', index >= rating);
      });
    });

    star.addEventListener('mouseout', function() {
      const currentRating = parseInt(ratingInput.value) || 0;
      Array.from(stars).forEach((s, index) => {
        s.classList.toggle('text-yellow-400', index < currentRating);
        s.classList.toggle('text-gray-300', index >= currentRating);
      });
    });
  });
});
</script>